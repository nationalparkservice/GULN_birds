---
title: "GULN birds - EDA of 2016-2021 data"
author: Ellen Cheng
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: kable
    fig_caption: yes
    highlight: haddock
    keep_md: yes
    smart: no
    theme: journal
    number_sections: yes
    toc: yes
    toc_float: 
      collapse: true
    toc_depth: 3
  html_notebook:
    chunk_output_type: inline
  word_document:
    toc: yes
    toc_depth: 3
  pdf_document:
    df_print: kable
    highlight: haddock
    fig_caption: yes
    keep_tex: yes
    number_sections: yes
    toc: yes
    toc_depth: 3
---
```{css, echo=FALSE}

body .main-container {
      max-width: 100% !important;
      width: 100% !important;
    }
    
```
    
```{r setup, include = FALSE}
rm(list=ls())

pkgs <- c("tidyverse", "here", "magrittr", "lubridate", "scales", "plotly", "knitr", "crosstalk", "reactable", "htmltools", "sparkline", "sf")
installed_pkgs <- pkgs %in% installed.packages()
if (length(pkgs[!installed_pkgs]) > 0)  install.packages(pkgs[!installed_pkgs],dep=TRUE)
invisible(lapply(pkgs, library, character.only = TRUE))

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, out.width = "100%", cache = FALSE, tidy = TRUE)
```

```{r functions}
# Reactable bar chart function 
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
  }

# Reactable status badge formatting
status_badge <- function(color = "#aaa", width = "9px", height = width) {
  span(style = list(
    display = "inline-block",
    marginRight = "8px",
    width = width,
    height = height,
    backgroundColor = color,
    borderRadius = "50%"
  ))
}

# Reactable tooltip formatting
with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help", title = tooltip, value)
}

# Color scale for conditional formatting
col_func <- function(x){
  ifelse(!is.na(x),
         rgb(colorRamp(c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"))(x), maxColorValue = 255),
         "#e9e9e9") #grey
  }

style_avg_detect <- function(value) {
          color <- col_func(value/max(df_species[grep("avg_", names(df_species))], na.rm = T)) # normalize the values to color scale
          list(background = color)
          }
```

```{r}
# Read in formatted data ----
df_locs <- readRDS(here::here("Data_out", "df_locs.RDS")) # site locations
df_survey_conditions <- readRDS(here::here("Data_out", "df_survey_conditions.RDS")) # event covariate data
df_full_obs <- readRDS(here::here("Data_out", "df_full_obs.RDS"))

    # dplyr::mutate(hover_label = paste("NPS Unit: ", site_name, "<br>Unit Code: ", unit_code, "<br>Location Code: ", location_name, "<br>Year: ", yr, "<br>W/in Year Visit#: ", within_year_visit, "<br>Event Date: ", event_date, "<br>Species Code: ", species_code, "<br>Species Scientific Name: ", scientific_name, "<br>Species Common Name: ", common_name, "<br># Detected Indiv: ", sum_indiv)) 

# Summary counts ----
# If the same number of locations is surveyed each yr_visit, this could be useful for getting a coarse sense of changes over time in the number of detected individuals per species, in each park unit
df_summary_yr_visit <- df_full_obs %>%
  dplyr::group_by(unit_code, species_code, yr_visit) %>%
  dplyr::summarize(
    yr_visit_detect = sum(sum_indiv, na.rm = TRUE),
    perc_loc_detect = round(100*length(unique(location_name[sum_indiv>0]))/length(unique(location_name)))
  ) %>% ungroup()

calc_avg_yr_visit <- df_summary_yr_visit %>%
  dplyr::group_by(unit_code, species_code) %>%
  dplyr::summarize(
    avg_yr_visit_detect = round(mean(yr_visit_detect, na.rm = TRUE), 2)
  )

species_sparkbar <- df_full_obs %>%
  dplyr::group_by(unit_code, species_code, yr) %>%
  dplyr::arrange(unit_code, species_code, yr) %>%
  dplyr::summarize(
    avg_surv_detect = round(mean(sum_indiv, na.rm = TRUE), 2)) %>%
  dplyr::mutate(
    spark_avg_yr = list(avg_surv_detect)) %>%
  dplyr::select(unit_code, species_code, spark_avg_yr) %>%
  distinct()
  
df_detail_species <- df_full_obs %>%
  dplyr::group_by(unit_code, species_code) %>%
  dplyr::summarize(
    avg_surv_detect = round(mean(sum_indiv, na.rm = TRUE), 2),
    n_locs = length(unique(location_name)), # this is the number of survey locations at a unit
    perc_loc_detect = round(100*length(unique(location_name[sum_indiv>0]))/n_locs), # this is the % of survey locations at which the species was detected at least once (in any survey event),=
    n_surv = n(), # number of survey events (survey event = 10-min point count at a location)
    perc_surv_detect = round(100*sum(sum_indiv > 0)/n()) # this is the % of survey events in which the species was detected
    ) %>% 
  dplyr::ungroup() %>%
  dplyr::full_join(calc_avg_yr_visit, by = c("unit_code", "species_code")) %>%
  dplyr::left_join(species_sparkbar, by = c("unit_code", "species_code")) %>%
  dplyr::select(unit_code, species_code, avg_surv_detect, spark_avg_yr, n_locs, perc_loc_detect, avg_yr_visit_detect, everything())

# This is the master table by species  
df_species <- df_full_obs %>%
  dplyr::group_by(unit_code, species_code, scientific_name, common_name, landbird) %>%
  dplyr::summarize(
    avg_surv_detect = round(mean(sum_indiv, na.rm = TRUE), 2), # this is the average # of individuals detected per survey event (does not consider how many times a particular location surveyed)
  ) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = unit_code, values_from = avg_surv_detect, names_prefix = "avg_") %>%
  dplyr::mutate(across(starts_with("avg_"), ~ifelse(is.na(.x),0,.x))) %>%
  dplyr::mutate(AVG_PARKS = round(rowMeans(.[grep("avg_", names(.))]), 2)) %>%
  dplyr::arrange(desc(AVG_PARKS)) %>%
  dplyr::select(species_code, scientific_name, common_name, landbird, AVG_PARKS, everything())
  
rm(df_summary_yr_visit); rm(calc_avg_yr_visit); rm(species_sparkbar)
```

# Overview of Protocol and Data

## Monitoring Objective
Document species richness and composition of breeding landbirds during annual visits to the parks and assess long-term trends in occupancy and the relative abundance or density for the most common  species.

## Sites and Sampling Frequency
Point counts are conducted twice per breeding season (May - June) at at each of six parks within the Gulf Coast Network. Each park has 21 to 33 randomly selected, permanent point count locations, for a total of N = 179 point plots across the region.

The sampling frame excludes narrow buffers (25-50 meters) around park boundaries, and points are required to be at least 200–250 meters apart. The smaller buffer sizes are used in situations where the original buffers and distances could not accommodate the full set of points within the sampling frame polygon. Points are distributed as a simple random draw from within park boundaries, rather than targeting specific habitats or areas. For three parks, the sampling frame was a buffered polygon around the whole park, allowing for park-wide inference. For the remaining three parks, the network selected one or more contiguous units of the park as the sampling frame, to prevent excessive travel time, or to accommodate safety or park management interest. In one case (Jean Lafitte NHP&P), the sampling frame was buffered corridors along trails and roads, due to challenges with access into flooded areas of the park. For all six parks, the points were drawn from the whole sampling frame, but if a point was on or within 50 meters (164 ft) of a road, parking lot, or building, the next available alternate point was used instead.

All of a park’s points are visited within a four-day to two-week period, with 3–8 points completed each day. All points are resampled within two and ten days after the initial sampling and must be conducted between dawn and 10:30 a.m.

## Conducting Variable Circular Plot Point Counts

An observer navigates to the point-count location by GPS, and over a 10-minute period, records the number of individuals seen or heard of each bird species. The observer also records the distance of each bird from the observer’s location and the minute the bird was first observed. Distances are recorded in bands of 0–25 meters (0–82 feet [ft]), 25–50 meters (82–164 ft), 50–100 meters (164–328 ft) and greater than 100 meters (328 ft). Once a bird is detected and recorded (), it is removed from further consideration, reducing the probability that any individual bird is counted twice. Each point is re-sampled within ten days of the initial sample.

## Covariate Data

## Data Analysis

# Big Picture Summary of Species Detections

## Point Count Detections by Species and Park

Table is sorted descending by average detections per survey, across parks (AVG OF 6 PARKS)).

Detections are the number of unique individuals detected during a point count, WITHOUT CORRECTING FOR DETECTION PROBABILITY.

```{r}
reactable::reactable(df_species, 
                     defaultColDef = colDef(
                                     align = "center"
                                     ),
                     columns = list(
                       species_code = colDef(name = "Species Code"),
                       scientific_name = colDef(name = "Scientific Name"),
                       common_name = colDef(name = "Common Name"),
                       landbird = colDef(
                         name = "Landbird?"),
                       AVG_PARKS = colDef(header = with_tooltip("AVG OF 6 PARKS", "Average of park-specific averages, with equal weighting across parks (i.e., regardless of park size or number of point survey locations)"), style = style_avg_detect),
                       avg_BITH = colDef(header = with_tooltip("BITH (N=32)", "Average # of individuals detected per point-survey at BITH"), style = style_avg_detect),
                       `avg_GUIS-FL` = colDef(header = with_tooltip("GUIS-FL (N=13)", "Average # of individuals detected per point-survey at GUIS-FL"), style = style_avg_detect),
                       `avg_GUIS-MS` = colDef(header = with_tooltip("GUIS-MS (N=8)", "Average # of individuals detected per point-survey at GUIS-MS"), style = style_avg_detect),
                       avg_JELA = colDef(header = with_tooltip("JELA (N=32)", "Average # of individuals detected per point-survey at JELA"), style = style_avg_detect),
                       avg_SAAN = colDef(header = with_tooltip("SAAN (N=33)", "Average # of individuals detected per point-survey at SAAN"), style = style_avg_detect),
                       avg_VICK = colDef(header = with_tooltip("VICK (N=33)", "Average # of individuals detected per point-survey at VICK"), style = style_avg_detect)
                     ),
                     columnGroups = list(
                       colGroup(name = "Average Detections per Survey (# of point locations)", columns = c("AVG_PARKS", "avg_BITH", "avg_GUIS-FL", "avg_GUIS-MS", "avg_JELA", "avg_SAAN", "avg_VICK"))
                       ),
                     compact = TRUE,
                     bordered = TRUE, 
                     resizable = TRUE, 
                     striped = TRUE, 
                     highlight = TRUE,
                     filterable = TRUE, 
                     defaultSortOrder = "desc",
                     defaultSorted = "AVG_PARKS",
                     showPageSizeOptions = TRUE,
                     pageSizeOptions = c(15,30,50),
                     defaultPageSize = 15,
                     fullWidth = TRUE,
                     width = "auto",
                     details = function(index) {
                       detail_species <- 
                         df_detail_species[df_detail_species$species_code == df_species$species_code[index], ]
                       htmltools::div(
                         style = "padding: 20px",
                         reactable(detail_species,
                                   defaultColDef = colDef(
                                     align = "center"
                                     ),
                                   columns = list(
                                     unit_code = colDef(name = "Park Code"),
                                     species_code = colDef(show = FALSE),
                                     avg_surv_detect = colDef(header = with_tooltip("Detections/Survey", "Average # of individuals detected per point-survey"), maxWidth = 120, style = style_avg_detect),
                                       spark_avg_yr = colDef(
                                         header = with_tooltip("Detections Timeline", "Each point shows the average # of individuals detected per point-survey, by year"), cell = function(values) {
    sparkline(values, type = "line")}),
                                     n_locs = colDef(show = FALSE),
                                     perc_loc_detect = colDef(
                                       header = with_tooltip("%Locations Detected", "% of point survey locations at which species detected at least once"),
                                       width = 150,
                                       cell = function(value) {
                                         width <- paste0(value, "%")
                                         bar_chart(value, width = width, fill = "#fc5185", background = "#e1e1e1")
                                         }),
                                                                          avg_yr_visit_detect = colDef(
                                       header = with_tooltip("Detections/Sample Round", "On average, the number of individuals detected in a single round of sampling, i.e., each point survey location visited once (values >= 20 are highlighted yellow"),
                                       style = function(value) {
                                         color <- if_else(value >= 20, "yellow", NULL)
                                         list(background = color)
                                         }),
                                     n_surv = colDef(header = with_tooltip("# of Surveys", "# of point-surveys conducted"), maxWidth = 100),
                                     perc_surv_detect = colDef(
                                       header = with_tooltip("%Surveys Detected", "% of point-surveys in which species detected"),
                                       width = 150,
                                       cell = function(value) {
                                         width <- paste0(value, "%")
                                         bar_chart(value, width = width, fill = "#fc5185", background = "#e1e1e1")
                                         })
                                     ),
                                   outlined = TRUE,
                                   compact = TRUE,
                                   resizable = TRUE,
                                   defaultSortOrder = "desc",
                                   defaultSorted = "avg_surv_detect")
                       )
                       }
                     )

```

# Single Species Summaries

```{r}  
shared_full_obs <- SharedData$new(df_full_obs, ~species_code, group = "summary_counts_species") 
```

```{r}
filter_select(id = "summary_species", label = "Select a Species", sharedData = shared_full_obs, multiple = FALSE, group = ~species_code)
```

## Distribution of Detection Data

Detections are the number of unique individuals detected during a point count, WITHOUT CORRECTING FOR DETECTION PROBABILITY.

Hover over a violin plot/boxplot to see summary values.
```{r}
shared_full_obs %>%
  plot_ly(
    x = ~unit_code,
    y = ~sum_indiv,
    type = 'violin',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    )
  ) %>%
  layout(
    title = list(
      title = ~unique(common_name)
    ),
    xaxis = list(
      title = "Park Unit"
    ),
    yaxis = list(
      title = "Detections per Survey",
      zeroline = T
    )
  )
```

Detections by point location and survey event.

Orange cells indicate no survey conducted.

```{r}

plot_ly(
  shared_full_obs,
  x= ~ yr_visit,
  y= ~ location_name,
  z = ~ sum_indiv,
  height = 1800,
  colors = "Blues",
  # reversescale = TRUE,
  # hoverinfo = 'text',
  #           text = ~paste("Hour:", dat$x,
  #                         "<br> Day:", dat$y,
  #                         "<br> z:", dat$z)),
  type = "heatmap"
)%>% 
  layout(
    title = list(text=unique(shared_full_obs$species_code), y = 1.05, x = 0.5, xanchor = 'center', yanchor =  'top'), 
    plot_bgcolor = "lightorange",
    yaxis = list(autotick = F, tickvals = unique(shared_full_obs$location_name))) # <<<<<<<<<<< TITLE DOESN'T WORK

```



COUNTS VS. COVARIATES

## Detection Times and Distances 

DETECTION SUMMARY BY PARK
Histogram of detection distance - all data. Grouped by Park (and/or by habitat type). Width of histogram bars should be scaled.

Histogram of time-to-detection - all data. Grouped by Park (and/or by habitat type)

DETECTION SUMMARY BY POINT & SURVEY
## Drill-Down on Detection Times and Distances



DETECTION VS. COVARIATES


# Summary by Park Unit

## Park Summary
Table. Each row is a species. Cols are total detections, detections/survey, % point locations with a detection, % surveys with a detection. Then nested table shows results by survey round?

# Appendix of Interactive Graphs and Tables


```{r}

# FuncPlotCaves(func_dat = shared_df_final)
# plot_ly(
#   shared_df_final,
#   x= ~ event_date,
#   y= ~ summary_maxem,
#   group = ~event_date,
#   color = ~method,
#   # shape = ~total_duration==75,
#   text = ~paste("Cave: ", cave, "<br>Entrance: ", entrance, "<br>Survey Date: ", event_date, "<br>Method: ", method, "<br>Maxem: ", summary_maxem, "<br>Surveyor: ", surveyor, "<br>Weather: ", weather, "<br>Wind Strength: ", wind_strength, "<br>Infrared Light Used: ", infrared_light_used, "<br>Human Disturbance: ", human_disturbance, "<br>Data Entry Flag: ", has_data_entry_flag),
#   type = "scatter",
#   mode = "markers",
#   size = 2) %>%
#   layout(
#     title = "Maximum Emergence Counts by Method and Date<br><sub>Open circles are incomplete surveys (missing intervals)</sub>",
#     xaxis = list(
#       title = "Survey Date",
#       showspikes = TRUE),
#     yaxis = list(
#       title = "Maximum Emergence Count"
#     ),
#     legend = list(
#       orientation = "h",
#       xanchor = "center",
#       x = 0.5,
#       y = 1.1)
#     )
```

```{js}
function filter_default(){
  document.getElementById("summary_species").getElementsByClassName("selectized")[0].selectize.setValue("NOCA",false) 
}$(document).ready(filter_default);
```