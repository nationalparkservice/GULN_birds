---
title: "GULN birds - Exploratory Data Analysis"
output:
  flexdashboard::flex_dashboard:
    theme: yeti
    orientation: columns
runtime: shiny
---
```{r setup}
rm(list=ls())

pkgs <- c("shiny", "knitr", "flexdashboard", "here", "tidyverse", "magrittr", "lubridate", "scales", "plotly","reactable", "htmltools", "sparkline")
installed_pkgs <- pkgs %in% installed.packages()
if (length(pkgs[!installed_pkgs]) > 0) install.packages(pkgs[!installed_pkgs],dep=TRUE) 
invisible(lapply(pkgs, library, character.only = TRUE))

rv <- reactiveValues(
  dat = NULL,
  locs = NULL,
  covs = NULL) # clear everything
```

```{r css_and_html}
# This expands maps to fill screen
tags$style("map {
           height: calc(100vh - 80px) !important;
           }")

# Add left and right margin padding on columns
tags$style(".dashboard-column {
    padding-left: 10px;
    padding-right: 10px;
}")

tags$style(".reactable {
font-size: 14px; 
}") # font size for reactable tables

# Reactable tooltip formatting
with_tooltip <- function(value, tooltip) {
  tags$abbr(style = "text-decoration: underline; text-decoration-style: dotted; cursor: help", title = tooltip, value)
}

# # Reactable status badge formatting
# status_badge <- function(color = "#aaa", width = "9px", height = width) {
#   span(style = list(
#     display = "inline-block",
#     marginRight = "8px",
#     width = width,
#     height = height,
#     backgroundColor = color,
#     borderRadius = "50%"
#   ))
# }
```

```{r functions}
# Reactable bar chart function 
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
  }

# Color scale for conditional formatting
col_func <- function(x){
  ifelse(!is.na(x),
         rgb(colorRamp(c("#ffffff", "#f2fbd2", "#c9ecb4", "#93d3ab", "#35b0ab"))(x), maxColorValue = 255),
         "#e9e9e9") #grey
  }

style_avg_detect <- function(value) {
          color <- col_func(value/max(df_species[grep("avg_", names(df_species))], na.rm = T)) # normalize the values to color scale
          list(background = color)
}

FuncYrBoxPlotly <- function(dat) {
  # total height
  num_facet_rows <- length(unique(dat$unit_code))
  total_page_ht <- 150 + 150 * num_facet_rows + 10 * num_facet_rows

  # subplot function
  subplot_box <- . %>% 
    plot_ly(height = total_page_ht) %>%
    add_trace(x = ~yr, y = ~sum_indiv, type = "box", boxmean = TRUE, color = I("gray"), alpha = 0) %>%
    add_markers(x = ~jitter(yr),  # this is better than boxpoints b/c boxpoints can't have hover info
                y = ~jitter(sum_indiv),
                color = I("lightblue"),
                marker = list(size = 6),
                text = ~hover_text, 
                hoverinfo = "text") %>%
    layout(
      xaxis = list(
        title = "Year"
        ),
      yaxis = list(
        title = "Counts per survey",
        zeroline = T
      )
    ) %>%
  add_annotations(
    text = ~unique(unit_code),
    x = 0.5,
    y = 1.02,
    yref = "paper",
    xref = "paper",
    xanchor = "middle",
    yanchor = "bottom",
    showarrow = FALSE,
    font = list(size = 15)
    )
  
  dat %>%
    dplyr::group_by(unit_code) %>%
    plotly::do(p = subplot_box(.)) %>%
    subplot(
      nrows = NROW(.), 
      shareX = TRUE, 
      shareY = TRUE,
      titleX = TRUE,
      margin = c(0.01, 0.01, 0.015, 0.01), # this is the subplot margin, L R T B
      which_layout = 1) %>%
    layout(
      title = "Each (jittered) point is a point count",
      margin = list(l = 75, r = 20,
                    b = 75, t = 75) # adds space to top and bottom of page
    ) %>%
    hide_legend(.)
}
```

```{r reactives}
renderUI({
  shiny::req(!is.null(df_full_obs_cov), !is.null(input$sel_park), !is.null(input$sel_species))

  rv$dat <- df_full_obs_cov %>%
    dplyr::filter(unit_code %in% input$sel_park & common_name %in% input$sel_species)
})
```

```{r}
# Read in formatted data ----

# Important changes:
# > recoded phys Woodland* and Forest* b/c multiple versions of same category
# > recoded sky conditions so order is fog < drizzle < rain, instead of rain < fog < drizzle


df_locs <- readRDS(here::here("Data_out", "df_locs.RDS")) # site locations
df_survey_conditions <- readRDS(here::here("Data_out", "df_survey_conditions.RDS")) # event covariate data
df_full_obs <- readRDS(here::here("Data_out", "df_full_obs.RDS"))

# Combine observation and covariate data ----
df_full_obs_cov <- df_full_obs %>%
  dplyr::left_join(df_locs[c("location_name", "physiognomy", "hab_type")], by = "location_name") %>%
  dplyr::left_join(df_survey_conditions[c("location_name", "event_date", "julian_prop", "start_time_interval", "weather_wind", "weather_wind_num", "weather_temperature", "weather_sky", "weather_sky_revised_num", "weather_noise", "weather_noise_num")], by = c("location_name", "event_date")) %>%
  dplyr::mutate(hover_text = paste0("<span style='font-size:16px; font-weight:bold;'>", unit_code, "<br>", paste0(scientific_name, " / ", common_name, " (", species_code, ")"), "</span><br>Location: ", location_name, "<br>Habitat Type: ", hab_type, "<br>Survey Date: ", event_date, "<br># of Individuals: ", sum_indiv))

# Summary counts ----
df_summary_yr_visit <- df_full_obs_cov %>%
  dplyr::group_by(unit_code, species_code, yr_visit) %>%
  dplyr::summarize(
    yr_visit_detect = sum(sum_indiv, na.rm = TRUE),
    perc_loc_detect = round(100*length(unique(location_name[sum_indiv>0]))/length(unique(location_name)))
  ) %>% ungroup()

calc_avg_yr_visit <- df_summary_yr_visit %>%
  dplyr::group_by(unit_code, species_code) %>%
  dplyr::summarize(
    avg_yr_visit_detect = round(mean(yr_visit_detect, na.rm = TRUE), 2)
  )

species_sparkbar <- df_full_obs_cov %>%
  dplyr::group_by(unit_code, species_code, yr) %>%
  dplyr::arrange(unit_code, species_code, yr) %>%
  dplyr::summarize(
    avg_surv_detect = round(mean(sum_indiv, na.rm = TRUE), 2)) %>%
  dplyr::mutate(
    spark_avg_yr = list(avg_surv_detect)) %>%
  dplyr::select(unit_code, species_code, spark_avg_yr) %>%
  distinct()
  
df_detail_species <- df_full_obs_cov %>%
  dplyr::group_by(unit_code, species_code) %>%
  dplyr::summarize(
    avg_surv_detect = round(mean(sum_indiv, na.rm = TRUE), 2),
    n_locs = length(unique(location_name)), # this is the number of survey locations at a unit
    perc_loc_detect = round(100*length(unique(location_name[sum_indiv>0]))/n_locs), # this is the % of survey locations at which the species was detected at least once (in any survey event),=
    n_surv = n(), # number of survey events (survey event = 10-min point count at a location)
    perc_surv_detect = round(100*sum(sum_indiv > 0)/n()) # this is the % of survey events in which the species was detected
    ) %>% 
  dplyr::ungroup() %>%
  dplyr::full_join(calc_avg_yr_visit, by = c("unit_code", "species_code")) %>%
  dplyr::left_join(species_sparkbar, by = c("unit_code", "species_code")) %>%
  dplyr::select(unit_code, species_code, avg_surv_detect, spark_avg_yr, n_locs, perc_loc_detect, avg_yr_visit_detect, everything())

# This is the master table by species  
df_species <- df_full_obs_cov %>%
  dplyr::group_by(unit_code, species_code, scientific_name, common_name, landbird) %>%
  dplyr::summarize(
    avg_surv_detect = round(mean(sum_indiv, na.rm = TRUE), 2), # this is the average # of individuals detected per survey event (does not consider how many times a particular location surveyed)
  ) %>%
  dplyr::ungroup() %>%
  tidyr::pivot_wider(names_from = unit_code, values_from = avg_surv_detect, names_prefix = "avg_") %>%
  dplyr::mutate(across(starts_with("avg_"), ~ifelse(is.na(.x),0,.x))) %>%
  dplyr::mutate(AVG_PARKS = round(rowMeans(.[grep("avg_", names(.))]), 2)) %>%
  dplyr::arrange(desc(AVG_PARKS)) %>%
  dplyr::select(species_code, scientific_name, common_name, landbird, AVG_PARKS, everything())
  
rm(df_full_obs); rm(df_summary_yr_visit); rm(calc_avg_yr_visit); rm(species_sparkbar)


```
 
Big Picture Summary of Sampling Effort
=========================================

Column {data-width=1}
-------------------------------------

Column {data-width=30}
-------------------------------------
### Distribution of sample location habitat types across park units
```{r}
unique(df_full_obs_cov[c("unit_code", "location_name", "hab_type")]) %>% dplyr::select(unit_code, hab_type) %>% table() %>% knitr::kable(.) %>% kableExtra::kable_styling(., bootstrap_options = "striped", position = "center", full_width = F)
```

### Summary of missed locations

Column {data-width=60}
-------------------------------------
### Weekly timing of surveys
```{r}
renderPlotly({
  shiny::req(!is.null(df_survey_conditions))
  survey_wk_heatdat <- df_survey_conditions %>% 
  dplyr::mutate(
    wk = lubridate::week(event_date),
    yr = lubridate::year(event_date)) %>%
  dplyr::select(unit_code, yr, wk) %>%
  dplyr::distinct() %>%
  dplyr::mutate(has_survey = 1) %>%
  dplyr::full_join(., tidyr::expand_grid(unit_code = sort(unique(.$unit_code)), yr = min(.$yr):max(.$yr), wk = min(.$wk):max(.$wk))) %>% # explicitly fills 0's so I can assign an NA color in plot. Every unit code gets every combination of year and week.
  dplyr::mutate_at(vars("has_survey"), ~replace_na(.,0)) %>%
  dplyr::mutate(hover_text = paste0("<span style='font-size:16px; font-weight:bold;'>", unit_code, "</span><br>Year: ", yr, "<br>Week: ", wk, "<br>Surveyed? ", ifelse(has_survey == 1, "YES", "NO")))

# total height
num_facet_rows <- ceiling(length(unique(survey_wk_heatdat$unit_code))/2) 
total_page_ht <- 150 + 12 * length(min(survey_wk_heatdat$wk):max(survey_wk_heatdat$wk)) * num_facet_rows + 10 * num_facet_rows

# subplot function
subplot_wk <- . %>% plot_ly(
    x = ~wk,
    y = ~yr,
    z = ~has_survey,
    xgap = 1, # adds the white lines btwn heatmap cells
    ygap = 1,
    height = total_page_ht,
    colorscale = data.frame(z = c(0, 1), col = c("lightgray", "black")),
    type = "heatmap",
    text = ~hover_text,
    hoverinfo ="text"
    ) %>%
  layout(
    yaxis = list(
      title = "Year",
      tickprefix = "  " # hack for increasing space between y-axis title and tick labels
    ),
    xaxis = list(
      title = "Week of Year"
      )) %>%
  add_annotations(
    text = ~unique(unit_code),
    x = 0.5,
    y = 1.02,
    yref = "paper",
    xref = "paper",
    xanchor = "middle",
    yanchor = "bottom",
    showarrow = FALSE,
    font = list(size = 15)
    )

# subplot view
survey_wk_heatdat %>%
  dplyr::group_by(unit_code) %>%
  plotly::do(p = subplot_wk(.)) %>%
  subplot(
      nrows = ceiling(NROW(.)/2), 
      shareX = TRUE, 
      shareY = TRUE,
      margin = c(0.01, 0.01, 0.015, 0.01), # this is the subplot margin, L R T B
      which_layout = 1) %>%
  layout(
    title = "Survey weeks each year, by park unit (week 15 is mid-May; week 30 is July/Aug)",
    margin = list(l = 75, r = 20,
          b = 75, t = 75) # adds space to top and bottom of page
) %>%
  hide_colorbar(.)
})

```

Big Picture Summary of Species Detections
=========================================

#### <font size="3">**Add instructions here**</font>

* <font size="2"> Blah </font>

* <font size="2"> Blah </font>

* <font size="2"> Blah </font>

```{r}
reactable::reactable(df_species,
                     defaultColDef = colDef(
                                     align = "center"
                                     ),
                     columns = list(
                       species_code = colDef(name = "Species Code"),
                       scientific_name = colDef(name = "Scientific Name"),
                       common_name = colDef(name = "Common Name"),
                       landbird = colDef(
                         name = "Landbird?"),
                       AVG_PARKS = colDef(header = with_tooltip("AVG OF 6 PARKS", "Average of park-specific averages, with equal weighting across parks (i.e., regardless of park size or number of point survey locations)"), style = style_avg_detect),
                       avg_BITH = colDef(header = with_tooltip("BITH (N=32)", "Average # of individuals detected per point-survey at BITH"), style = style_avg_detect),
                       `avg_GUIS-FL` = colDef(header = with_tooltip("GUIS-FL (N=13)", "Average # of individuals detected per point-survey at GUIS-FL"), style = style_avg_detect),
                       `avg_GUIS-MS` = colDef(header = with_tooltip("GUIS-MS (N=8)", "Average # of individuals detected per point-survey at GUIS-MS"), style = style_avg_detect),
                       avg_JELA = colDef(header = with_tooltip("JELA (N=32)", "Average # of individuals detected per point-survey at JELA"), style = style_avg_detect),
                       avg_PAAL = colDef(header = with_tooltip("PAAL (N=29)", "Average # of individuals detected per point-survey at PAAL"), style = style_avg_detect),
                       avg_SAAN = colDef(header = with_tooltip("SAAN (N=33)", "Average # of individuals detected per point-survey at SAAN"), style = style_avg_detect),
                       avg_VICK = colDef(header = with_tooltip("VICK (N=32)", "Average # of individuals detected per point-survey at VICK"), style = style_avg_detect)
                     ),
                     columnGroups = list(
                       colGroup(name = "Average Detections per Survey (# of point locations)", columns = c("AVG_PARKS", "avg_BITH", "avg_GUIS-FL", "avg_GUIS-MS", "avg_JELA", "avg_PAAL", "avg_SAAN", "avg_VICK"))
                       ),
                     compact = TRUE,
                     bordered = TRUE,
                     resizable = TRUE,
                     striped = TRUE,
                     highlight = TRUE,
                     filterable = TRUE,
                     defaultSortOrder = "desc",
                     defaultSorted = "AVG_PARKS",
                     showPageSizeOptions = TRUE,
                     pageSizeOptions = c(15,30,50),
                     defaultPageSize = 15,
                     fullWidth = TRUE,
                     width = "auto",
                     details = function(index) {
                       detail_species <-
                         df_detail_species[df_detail_species$species_code == df_species$species_code[index], ]
                       htmltools::div(
                         style = "padding: 20px",
                         reactable(detail_species,
                                   defaultColDef = colDef(
                                     align = "center"
                                     ),
                                   columns = list(
                                     unit_code = colDef(name = "Park Code"),
                                     species_code = colDef(show = FALSE),
                                     avg_surv_detect = colDef(header = with_tooltip("Detections/Survey", "Average # of individuals detected per point-survey"), maxWidth = 120, style = style_avg_detect),
                                       spark_avg_yr = colDef(
                                         header = with_tooltip("Detections Timeline", "Each point shows the average # of individuals detected per point-survey, by year"), cell = function(values) {
    sparkline(values, type = "line")}),
                                     n_locs = colDef(show = FALSE),
                                     perc_loc_detect = colDef(
                                       header = with_tooltip("%Locations Detected", "% of point survey locations at which species detected at least once"),
                                       width = 150,
                                       cell = function(value) {
                                         width <- paste0(value, "%")
                                         bar_chart(value, width = width, fill = "#fc5185", background = "#e1e1e1")
                                         }),
                                                                          avg_yr_visit_detect = colDef(
                                       header = with_tooltip("Detections/Sample Round", "On average, the number of individuals detected in a single round of sampling, i.e., each point survey location visited once (values >= 20 are highlighted yellow"),
                                       style = function(value) {
                                         color <- if_else(value >= 20, "yellow", NULL)
                                         list(background = color)
                                         }),
                                     n_surv = colDef(header = with_tooltip("# of Surveys", "# of point-surveys conducted"), maxWidth = 100),
                                     perc_surv_detect = colDef(
                                       header = with_tooltip("%Surveys Detected", "% of point-surveys in which species detected"),
                                       width = 150,
                                       cell = function(value) {
                                         width <- paste0(value, "%")
                                         bar_chart(value, width = width, fill = "#fc5185", background = "#e1e1e1")
                                         })
                                     ),
                                   outlined = TRUE,
                                   compact = TRUE,
                                   resizable = TRUE,
                                   defaultSortOrder = "desc",
                                   defaultSorted = "avg_surv_detect")
                       )
                       }
                     )

```

Drill-Down by Park and Species
=========================================

Inputs {.sidebar data-width=250}
-------------------------------------
```{r input} 
renderUI({
  shiny::req(!is.null(df_full_obs_cov))
  checkboxGroupInput("sel_park",
                     label = h6("Select Park(s): "),
                     choices = sort(unique(df_full_obs_cov$unit_code)),
                     selected = switch(is.null(input$sel_park)+1, input$sel_park, unique(df_full_obs_cov$unit_code))
                     )
  })

renderUI({
  shiny::req(!is.null(df_full_obs_cov))
  selectInput(
    "sel_species",
    label = strong("Select a Species: "),
    choices = sort(unique(df_full_obs_cov$common_name)),
    selected = switch(is.null(input$sel_species)+1, input$sel_species, "Northern Cardinal")
    )
  })
```

Tabs {.tabset .tabset-fade}
-------------------------------------

### Attempt at Brushing

Counts are the number of unique individuals detected during a point count, WITHOUT CORRECTING FOR DETECTION PROBABILITY.

```{r}
renderPlotly({
  shiny::req(!is.null(rv$dat))
  FuncYrBoxPlotly(dat = rv$dat)
})
```

### Heatmap

#### <font size="3">**Add instructions here**</font>

* <font size="2"> Blah </font>

* <font size="2"> Blah </font>

* <font size="2"> Blah </font>

```{r}
renderPlotly({
  shiny::req(!is.null(rv$dat), !is.null(input$sel_species), !is.null(input$sel_park))

# total height
total_page_ht <- 150 + 15 * length(unique(rv$dat$location_name)) + 10 * length(unique(rv$dat$unit_code))

# relative heights
loc_heights <-
  rv$dat %>% dplyr::group_by(unit_code) %>% summarize(num_locs = n_distinct(location_name)) %>% dplyr::pull(num_locs)+10 
rel_heights <- proportions(loc_heights)

# create discrete colorbar
max_count <- max(rv$dat$sum_indiv, na.rm = TRUE)
vir_colors <- c("#D3D3D3", scales::viridis_pal(direction = -1)(max_count)) # first one is light gray, which is assigned to count = 0
names(vir_colors) = 0:max_count

Z_Breaks = function(n){ # make the color table
CUTS = seq(0,1,length.out=n+1)
rep(CUTS,ifelse(CUTS %in% 0:1,1,2))
}

color_table <- data.frame(z=Z_Breaks(length(vir_colors)),
col=rep(vir_colors,each=2),stringsAsFactors=FALSE)

# subplot function
subplot_counts <- . %>% plot_ly(
    x = ~yr_visit,
    y = ~location_name,
    z = ~sum_indiv,
    xgap = 1, # adds the white lines btwn heatmap cells
    ygap = 1,
    height = total_page_ht,
    # colorbar(orientation = "h"), # should be available in the next plot_ly package version
    colorscale = color_table,
    colorbar=list(title = "# of Indiv.", tickmode = "array", tickvals = 0:max_count, ticktext = names(vir_colors)),
    zmin = 0, 
    zmax = max_count, # finally figured how to set the colorbar limits
    type = "heatmap",
    text = ~hover_text,
    hoverinfo ="text"
    ) %>%
  layout(
    yaxis = list(
      title = "Location Name",
      tickfont = list(size=10),
      tickprefix = "  " # hack for increasing space between y-axis title and tick labels
    ),
    xaxis = list(
      title = "Survey Round (Year-Visit)",
      tickfont = list(size=10)
      )) %>%
  add_annotations(
    text = ~unique(unit_code),
    x = 0.5,
    y = 1.02,
    yref = "paper",
    xref = "paper",
    xanchor = "middle",
    yanchor = "bottom",
    showarrow = FALSE,
    font = list(size = 15)
    )

# subplot view
rv$dat %>%
  dplyr::group_by(unit_code) %>%
  plotly::do(p = subplot_counts(.)) %>%
  subplot(
      nrows = NROW(.),
      shareX = FALSE,
      shareY = FALSE,
      titleX = FALSE,
      titleY = TRUE,
      heights = rel_heights,
      margin = c(0, 0, 0.04, 0.01), # this is the subplot margin, L R T B
      which_layout = 1) %>%
  layout(
    title = "Counts by location and survey event (not corrected for detection probability)",
    margin = list(l = 75, r = 20,
          b = 75, t = 75) # adds space to top and bottom of page
  ) %>%
  hide_colorbar(.)

})
```
